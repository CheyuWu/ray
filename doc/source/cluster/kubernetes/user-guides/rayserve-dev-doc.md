(kuberay-dev-serve)=

# Developing Ray Serve Python scripts on a RayCluster

In this tutorial, you will learn how to effectively debug your Ray Serve scripts against a RayCluster, enabling enhanced observability and faster iteration speed compared to developing the script directly with a RayService.
Many RayService issues are related to the Ray Serve Python scripts, so it is important to ensure the correctness of the scripts before deploying them to a RayService.
This tutorial will show you how to develop a Ray Serve Python script for a MobileNet image classifier on a RayCluster.
You can deploy and serve the classifier on your local Kind cluster without requiring a GPU.
Refer to [ray-service.mobilenet.yaml](https://github.com/ray-project/kuberay/blob/v1.3.0/ray-operator/config/samples/ray-service.mobilenet.yaml) and [mobilenet-rayservice.md](kuberay-mobilenet-rayservice-example) for more details.


# Step 1: Install a KubeRay cluster

Follow [this document](kuberay-operator-deploy) to install the latest stable KubeRay operator via Helm repository.

# Step 2: Create a RayCluster CR

```sh
helm install raycluster kuberay/ray-cluster --version 1.4.0
```

# Step 3: Log in to the head Pod

```sh
export HEAD_POD=$(kubectl get pods --selector=ray.io/node-type=head -o custom-columns=POD:metadata.name --no-headers)
kubectl exec -it $HEAD_POD -- bash
```

# Step 4: Prepare your Ray Serve Python scripts and run the Ray Serve application

```sh
# Execute the following command in the head Pod
git clone https://github.com/ray-project/serve_config_examples.git
cd serve_config_examples

# Try to launch the Ray Serve application
serve run mobilenet.mobilenet:app
# [Error message]
#     from tensorflow.keras.preprocessing import image
# ModuleNotFoundError: No module named 'tensorflow'
```

* `serve run mobilenet.mobilenet:app`: The first `mobilenet` is the name of the directory in the `serve_config_examples/`,
the second `mobilenet` is the name of the Python file in the directory `mobilenet/`, and `app` is the name of the variable representing Ray Serve application within the Python file. See the section "import_path" in [rayservice-troubleshooting.md](kuberay-raysvc-troubleshoot) for more details.

# Step 5: Use the UV Environment to Install Required Packages

```sh
# Deactivate the conda environment
conda deactivate

# Initialize the UV environment
uv init

# Install the required packages
uv add tensorflow pillow ray[serve]==2.46.0
```

The error message in Step 4 indicates that the Ray image `rayproject/ray:${RAY_VERSION}` does not have the TensorFlow package.
Due to the significant size of TensorFlow, we have opted to use an image with TensorFlow as the base instead of installing it within {ref}`Runtime Environments <runtime-environments>`.
In this step, we use UV to manage our Python package environment.

# Step 6: Launch Ray Serve with UV in the Background

```sh
# This time, you should be able to successfully launch the Ray Serve application using the UV environment in the background.
uv run -- serve run mobilenet.mobilenet:app --runtime-env-json '{"pip": ["tensorflow==2.19.0", "pillow"]}' > serve.log 2>&1 &

# [Example output]
# (ServeReplica:default_ImageClassifier pid=139, ip=10.244.0.8) Downloading data from https://storage.googleapis.com/tensorflow/keras-applications/mobilenet_v2/mobilenet_v2_weights_tf_dim_ordering_tf_kernels_1.0_224.h5
#     8192/14536120 [..............................] - ETA: 0s)
#  4202496/14536120 [=======>......................] - ETA: 0s)
# 12902400/14536120 [=========================>....] - ETA: 0s)
# 14536120/14536120 [==============================] - 0s 0us/step
# 2023-07-17 14:04:43,737 SUCC scripts.py:424 -- Deployed Serve app successfully.
```

# Step 7: Submit a request to the Ray Serve application

```sh
# (On your local machine)
# Forward the serve port from the head Pod
export HEAD_POD=$(kubectl get pods --selector=ray.io/node-type=head -o custom-columns=POD:metadata.name --no-headers)
kubectl port-forward $HEAD_POD 8000

# (On your local machine)
# Clone the repository
git clone https://github.com/ray-project/serve_config_examples.git
cd serve_config_examples/mobilenet

# (On your local machine)
# Download a sample image file. `stable_diffusion_example.png` is a cat image generated by the Stable Diffusion model.
curl -O https://raw.githubusercontent.com/ray-project/kuberay/v1.3.0/docs/images/stable_diffusion_example.png

# (On your local machine)
# Update the `image_path` variable in `mobilenet_req.py` to point to `stable_diffusion_example.png`
# Then send a request to the Ray Serve application.
python3 mobilenet_req.py

# [Error message]
Internal Server Error

# Switch back to the head Pod and inspect the logs
cat serve.log
# [Error message]
ERROR 2025-06-21 23:13:07,994 default_ImageClassifier y4qmemck a9efb0dd-107c-4ccd-b4c8-70cb79b821ba -- Request failed.
Traceback (most recent call last):
  File "/home/ray/anaconda3/lib/python3.9/site-packages/ray/serve/_private/replica.py", line 1640, in call_user_method
    result, sync_gen_consumed = await self._call_func_or_gen(
  File "/home/ray/anaconda3/lib/python3.9/site-packages/ray/serve/_private/replica.py", line 1347, in _call_func_or_gen
    result = await result
  File "/home/ray/serve_config_examples/./mobilenet/mobilenet.py", line 24, in __call__
    request = await http_request.form()
  File "/home/ray/anaconda3/lib/python3.9/site-packages/starlette/requests.py", line 259, in _get_form
    assert (
AssertionError: The `python-multipart` library must be installed to use form parsing.
INFO 2025-06-21 23:13:07,996 default_ImageClassifier y4qmemck a9efb0dd-107c-4ccd-b4c8-70cb79b821ba -- POST / 500 3.1ms
```

`python-multipart` is required for the request parsing function `starlette.requests.form()`, so the error message is reported when we send a request to the Ray Serve application.

# Step 8: Restart the Ray Serve Application with the Correct Runtime Environment

```sh
# Inside the head Pod, shut down the existing Ray Serve application
uv run -- serve shutdown

# Check the status of the Ray Serve application
uv run -- serve status
# [Example output]
# proxies: {}
# applications: {}
# target_capacity: null

# This indicates that no applications are currently running on the cluster.

# Install python-multipart using UV
uv add python-multipart==0.0.6

# Launch the Ray Serve application with the updated runtime environment
uv run -- serve run mobilenet.mobilenet:app --runtime-env-json '{"pip": ["tensorflow==2.19.0", "pillow", "python-multipart==0.0.6"]}'

# (On your local machine)
# Submit a request to the Ray Serve application again. This time, you should receive a correct prediction.
python3 mobilenet_req.py
# [Example output]
# {"prediction": ["n02123159", "tiger_cat", 0.2994779646396637]}
```

# Step 9: Create a RayService YAML file

In the previous steps, we found that the Ray Serve application can be successfully launched using the Ray image `rayproject/ray-ml:${RAY_VERSION}` and the {ref}`runtime environments <runtime-environments>` `python-multipart==0.0.6`.
Therefore, we can create a RayService YAML file with the same Ray image and runtime environment.
For more details, please refer to [ray-service.mobilenet.yaml](https://github.com/ray-project/kuberay/blob/v1.3.0/ray-operator/config/samples/ray-service.mobilenet.yaml) and [mobilenet-rayservice.md](kuberay-mobilenet-rayservice-example).
